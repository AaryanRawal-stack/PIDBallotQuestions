---
output:
  pdf_document: default
  html_document: default
---

```{r include = FALSE}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(readxl)
library(gt)
library(tidyr)
```

# _ DATA IMPORTATION _

##IMPORTING DATA
The following imports all the campaign finance data from the ballot question. 
```{r include = FALSE} 
setwd('~/Desktop/PID/Campaign_Finance_Data')

#Q2022
OpposeTaxHike <- read_xlsx("~/Desktop/PID/Campaign_Finance_Data/BallotQuestions2022Data/Question1/Coalition_to_Stop_the_Tax_Hike_Amendment.xlsx")

CoalitionforSocialJusticeFairShare <- read_xlsx("~/Desktop/PID/Campaign_Finance_Data/BallotQuestions2022Data/Question1/CoalitionforSocialJusticeFairShare.xlsx")

Fair_Share_Massachusetts <- read_xlsx("~/Desktop/PID/Campaign_Finance_Data/BallotQuestions2022Data/Question1/Fair_Share_Massachusetts.xlsx") 

`Committee For Competitive Dental Plans for Consumers` <- read_xlsx("~/Desktop/PID/Campaign_Finance_Data/BallotQuestions2022Data/Question2/Committee For Competitive Dental Plans for Consumers.xlsx")
`Committee to Protect Access to Quality Dental Care` <- read_xlsx("~/Desktop/PID/Campaign_Finance_Data/BallotQuestions2022Data/Question2/Committee_to_Protect_Access_to_Quality_Dental_Care.xlsx")

`Massachusetts Dental Care Providers for Better Dental Benefits` <- read_xlsx("~/Desktop/PID/Campaign_Finance_Data/BallotQuestions2022Data/Question2/Massachusetts Dental Care Providers for Better Dental Benefits.xlsx")
`Committee on Dental Insurance Quality` <- read_xlsx("~/Desktop/PID/Campaign_Finance_Data/BallotQuestions2022Data/Question2/Committee on Dental Insurance Quality.xlsx")

`21st_Century_Alcohol_Retail_Reform_Committee` <- read_xlsx("~/Desktop/PID/Campaign_Finance_Data/BallotQuestions2022Data/Question3/21st_Century_Alcohol_Retail_Reform_Committee.xlsx")

`Fair_And_Secure_Massachusetts` <- read_xlsx("~/Desktop/PID/Campaign_Finance_Data/BallotQuestions2022Data/Question4/Fair_And_Secure_Massachusetts.xlsx")

#Q2020
`Vote_YES_for_Work_and_Family_Mobility` <- read_xlsx("~/Desktop/PID/Campaign_Finance_Data/BallotQuestions2022Data/Question4/Vote_YES_for_Work_and_Family_Mobility.xlsx")

`Coalition_for_Safe_and_Secure_Data` <- read_xlsx("~/Desktop/PID/Campaign_Finance_Data/BallotQuestions2020Data/Question1/Coalition_for_Safe_and_Secure_Data.xlsx")

`Massachusetts_Right_to_Repair_Committee` <- read_xlsx("~/Desktop/PID/Campaign_Finance_Data/BallotQuestions2020Data/Question1/Massachusetts_Right_to_Repair_Committee.xlsx")

No_Ranked_Choice_Voting_Committee_2020 <- read_xlsx("~/Desktop/PID/Campaign_Finance_Data/BallotQuestions2020Data/Question2/No_Ranked_Choice_Voting_Committee 2020.xlsx")

Ranked_Choice_Voting_2020_Committee <- read_xlsx("~/Desktop/PID/Campaign_Finance_Data/BallotQuestions2020Data/Question2/Ranked_Choice_Voting_2020_Committee.xlsx")

#Q2018 
Coalition_to_Protect_Patient_Safety <- read_xlsx("~/Desktop/PID/Campaign_Finance_Data/BallotQuestions2018Data/Question1/Coalition_to_Protect_Patient_Safety.xlsx")

Committee_to_Ensure_Safe_Patient_Care <- read_xlsx("~/Desktop/PID/Campaign_Finance_Data/BallotQuestions2018Data/Question1/Committee_to_Ensure_Safe_Patient_Care.xlsx")

People_Govern_Not_Money <- read_xlsx("~/Desktop/PID/Campaign_Finance_Data/BallotQuestions2018Data/Question2/People_Govern_Not_Money.xlsx")

Freedom_for_All_Massachusetts_Inc <- read_xlsx("~/Desktop/PID/Campaign_Finance_Data/BallotQuestions2018Data/Question3/Freedom_for_All_Massachusetts_Inc.xlsx")

Keep_Massachusetts_Safe <- read_xlsx("~/Desktop/PID/Campaign_Finance_Data/BallotQuestions2018Data/Question3/Keep_Massachusetts_Safe.xlsx")

No_to_3 <- read_xlsx("~/Desktop/PID/Campaign_Finance_Data/BallotQuestions2018Data/Question3/No_to_3.xlsx")
```

##CREATING LIST
Lists combine multiple data frames into one vector, which we can then repeatedly add a function to. We also add a function to remove Aggregated Unitemized Receipts from the data (this is a sum of all contributions that isn't actually relavent to this data visualization). Finally, we name all the elements of the list. 

```{r include = FALSE} 
Q2022 <- list(OpposeTaxHike, CoalitionforSocialJusticeFairShare, Fair_Share_Massachusetts, `Massachusetts Dental Care Providers for Better Dental Benefits`, `Committee For Competitive Dental Plans for Consumers`, `Committee on Dental Insurance Quality`, `Committee to Protect Access to Quality Dental Care`, `21st_Century_Alcohol_Retail_Reform_Committee`, `Fair_And_Secure_Massachusetts`, `Vote_YES_for_Work_and_Family_Mobility`)


Q2022 <- lapply(Q2022, function(df) {
  df %>% filter(Contributor != "Aggregated Unitemized Receipts")
})

Q2022 <- list(
"Coalition to Stop the Tax Hike Amendment (Q1 2022, Oppose)" = OpposeTaxHike, 

"Coalition for Social Justice Fair Share (Q1 2022, Support)" = CoalitionforSocialJusticeFairShare, 

"Fair Share Massachusetts (Q1 2022, Support)" = `Fair_Share_Massachusetts`, 

"Massachusetts Dental Care Providers for Better Dental Benefits (Q2 2022, Support)" = `Massachusetts Dental Care Providers for Better Dental Benefits`,

"Committee For Competitive Dental Plans for Consumers (Q2 2022, Oppose)" = `Committee For Competitive Dental Plans for Consumers`, 

"Committee on Dental Insurance Quality (Q2 2022, Support)" = `Committee on Dental Insurance Quality`, 

"Committee to Protect Access to Quality Dental Care (Q2 2022, Oppose)" = `Committee to Protect Access to Quality Dental Care`,

"21st Century Alcohol Retail Reform Committee (Q3 2022, Support)" = `21st_Century_Alcohol_Retail_Reform_Committee`,

"Fair And Secure Massachusetts (Q4 2022, Oppose)" = `Fair_And_Secure_Massachusetts`,

"Vote YES for Work and Family Mobility (Q4 2022, Support)" = `Vote_YES_for_Work_and_Family_Mobility`

)

```

# _ FUNCTIONS _ 

##CLASSIFICATION FUNCTION
The following function classifies all donations into one of six categories (corporate, association/union, individual contribution more than 100k, individual contribution less than 100k, and refunds). Refunds will be excluded from the data analysis. The column this function creates is called `Category_PID`. 

```{r include = FALSE}
classification <- function(x) { 
  print("Applying classification function...")
  x <- x %>%       
    mutate(Category_PID = case_when(
      `Record Type Description` == "Corporate Inkind Contribution" ~ "Corporate", 
      `Record Type Description` == "Business Contribution" ~ "Corporate", 
      `Record Type Description` == "Union/Association" ~ "Union/Association",
      `Record Type Description` == "Individual" & Amount >= 100000 ~ "Individual More Than 100K", 
      `Record Type Description` == "Individual" & Amount < 100000 ~ "Individual Less Than 100K",
      `Record Type Description` == "Committee" ~ "PAC", 
      `Record Type Description` == "Non-Contribution" ~ "Refund"))
  print("Classification done.")
  print("Checking column names:")
  print(colnames(x))
  print("Checking first few rows of data:")
  print(head(x))
  return(x)
}
```

##SUMMARY TABLE FUNCTION
The following function outputs a table which states:
1. The number of contributions for each variable of `Category_PID`
2. The proportion of the number of all contributions for each variable of `Category_PID`. This is labelled `Proportion_Of_Contributions`.
3. The proportion of the amount of all contributions for each variable of `Category_PID`. This is labelled 
`Proportion_Of_All_Amount_Donated`.

```{r include = FALSE}
create_summary_table <- function(df_name, df) {
  print(paste("Creating table for:", df_name))  # Debugging statement
  summary_df <- df %>%
    filter(Category_PID != "Refund") %>%
    group_by(Category_PID) %>%
    summarize(
      Number_Of_Contributions = n(),
      Total_Amount_Donated = sum(Amount)
    ) %>%
    mutate(
      Proportion_Of_All_Contributions = Number_Of_Contributions / sum(Number_Of_Contributions),
      Proportion_Of_All_Amount_Donated = Total_Amount_Donated / sum(Total_Amount_Donated)
    ) |> complete(Category_PID = c("Corporate", "Individual Less Than 100K", "Individual More Than 100K", "Union/Association", "PAC"), fill = list(Number_Of_Contributions = 0, Total_Amount_Donated = 0, Proportion_Of_All_Contributions = 0, Proportion_Of_All_Amount_Donated = 0))

  gt(summary_df, rowname_col = "Category_PID") %>%
    tab_header(title = df_name) %>%
    cols_label(
      Number_Of_Contributions = "Number of Contributions", 
      Total_Amount_Donated = "Total Amount Donated", 
      Proportion_Of_All_Contributions = "Percentage of Contributions", 
      Proportion_Of_All_Amount_Donated = "Percentage of Total Amount Donated"
    ) %>%
    fmt_currency(columns = c("Total_Amount_Donated"), use_seps = TRUE) %>%
    fmt_percent(columns = c("Proportion_Of_All_Contributions", "Proportion_Of_All_Amount_Donated"), decimals = 2) %>%
    cols_move(Proportion_Of_All_Contributions, Number_Of_Contributions) %>%
    tab_style(
      style = cell_text(
        font = c(google_font(name = "Roboto"), default_fonts())
      ),
      locations = cells_body()
    )
}
``` 

#_ Output _ 
The following code produces the summary tables.

```{r echo = FALSE}
classified_tables_Q2022 <- lapply(Q2022, classification)

for (df_name in names(classified_tables_Q2022)) {
  cat("Table Name:", df_name, "\n")
  print(create_summary_table(df_name, classified_tables_Q2022[[df_name]]))
}

```


#_PRINT OUT_ 
The following code exports summary tables as PNGs. 

```{r}
export_summary_table_png <- function(summary_table, file_name) {
  #Place File
  output_dir <- "~/Desktop/PID/BallotQuestions2022"
  # Generate the file name with the .png extension
  png_file <- paste0(output_dir, file_name, ".png")
  # Save the summary table as a PNG file
  gtsave(summary_table, filename = png_file)
}


for (df_name in names(classified_tables_Q2022)) {
  cat("Table Name:", df_name, "\n")
  summary_table <- create_summary_table(df_name, classified_tables_Q2022[[df_name]])
  export_summary_table_png(summary_table, file_name = df_name)
}
```





